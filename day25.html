<!DOCTYPE HTML>
<html lang="zh-TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Day25|現實中的區塊鏈(2)：Bitcoin與Ethereum的交易架構 - 區塊鏈到底在幹嘛 - 30天系列</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">區塊鏈到底在幹嘛 - 30天系列</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="day25現實中的區塊鏈2bitcoin與ethereum的交易架構"><a class="header" href="#day25現實中的區塊鏈2bitcoin與ethereum的交易架構">Day25|現實中的區塊鏈(2)：Bitcoin與Ethereum的交易架構</a></h1>
<h1 id="bitcoin與ethereum的架構"><a class="header" href="#bitcoin與ethereum的架構">Bitcoin與Ethereum的架構</a></h1>
<p>昨天我們提到了區塊鏈與代幣的發展，今天我們會來解說目前最主流的兩大公鏈─Bitcoin與Ethereum。還記得我們在Day02-Day07有嘗試寫出一個最基本的區塊鏈嗎？稍後我們在講解架構時也會拿我們之前所寫的簡易區塊鏈做個簡單對照。</p>
<h1 id="bitcoin與ethereum的交易格式"><a class="header" href="#bitcoin與ethereum的交易格式">Bitcoin與Ethereum的交易格式</a></h1>
<p>回憶一下我們之前所寫的<code>get_balance</code>是專門用來取得某特定帳戶的餘額，因為區塊鏈上的代幣只會有三種來源：挖礦獎勵、挖到區塊中的手續費總和、收到別人的匯款款項，因此我們可以利用這三個來源把該帳戶的餘額統整起來。</p>
<pre><code>def get_balance(self, account):
    balance = 0
    for block in self.chain:
        # Check miner reward
        miner = False
        if block.miner == account:
            miner = True
            balance += block.miner_rewards
        for transaction in block.transactions:
            if miner:
                balance += transaction.fee
            if transaction.sender == account:
                balance -= transaction.amounts
                balance -= transaction.fee
            elif transaction.receiver == account:
                balance += transaction.amounts
    return balance
</code></pre>
<p>只是這樣並沒有辦法預防<code>雙花攻擊(Double Spending)</code>，也就是我們的確可以知道發起交易當下的用戶資產是否足夠，但卻無法保證使用者的餘額是否會被重複花用，因此只要交易紀錄尚未被寫進區塊內，<code>get_balance</code>所取得的餘額永遠不會減少，使用者可以無限制的發起交易並放置入<code>pending_transactions</code>等待礦工驗證。</p>
<p>即便是下面礦工打包交易所用的<code>add_transaction</code>函式中檢查餘額也只是檢查之前所有區塊的餘額，當下區塊的交易支出並沒有被計算進去，因此同一筆交易可以在新區塊中中不停出現而且不會被扣款。</p>
<pre><code>def add_transaction(self, transaction, signature):
    public_key = '-----BEGIN RSA PUBLIC KEY-----\n'
    public_key += transaction.sender
    public_key += '\n-----END RSA PUBLIC KEY-----\n'
    public_key_pkcs = rsa.PublicKey.load_pkcs1(public_key.encode('utf-8'))
    transaction_str = self.transaction_to_string(transaction)
    if transaction.fee + transaction.amounts &gt; self.get_balance(transaction.sender):
        return False, "Balance not enough!"
    try:
        # 驗證發送者
        rsa.verify(transaction_str.encode('utf-8'), signature, public_key_pkcs)
        self.pending_transactions.append(transaction)
        return True, "Authorized successfully!"
    except Exception:
        return False, "RSA Verified wrong!"
</code></pre>
<p>因此區塊鏈上所使用的交易格式必須能夠有效對抗這類的<code>雙花攻擊(Double Spending)</code>，另外也因為日常使用必須頻繁地確認帳戶餘額，同時交易格式的設計也要考量到盡可能地減少查閱餘額所需要的運算量。</p>
<h2 id="bitcoin的utxounspent-transaction-output架構"><a class="header" href="#bitcoin的utxounspent-transaction-output架構">Bitcoin的UTXO(Unspent Transaction Output)架構</a></h2>
<p>Bitcoin採用的是<code>UTXO(Unspent Transaction Output)架構</code>，直接翻譯過來便是還沒被用來支付的交易。你可以先把UTXO看作是一連串支票的集合，每張支票上面的數目不一，當你匯款給別人時，其實就是開給別人一張尚未支付的支票(UTXO)，接著如果別人想要使用，就把支票(UTXO)拿去匯款生成另一張尚未支付的UTXO給被匯款者，如果匯款後自身仍然有餘額便會再生成一張支票(UTXO給自己)</p>
<p><img src="http://www.lkm543.site/it_iron_man/day26_2.JPG" alt="UTXO" /></p>
<p>以上圖為例，當Bob收到別人所支付的5BTC時，就相當於收到別人給的5BTC的支票(UTXO)，如果Bob日後匯款2BTC給Ally，就等於利用這張5BTC的支票開給Ally一張價值2BTC的UTXO，至於剩下的3BTC則會生成另一張支票(UTXO給自己)，這個方式也能夠有效對抗雙花攻擊，因為每一張UTXO最多只能被使用一次。</p>
<p><img src="http://www.lkm543.site/it_iron_man/day26_3.JPG" alt="blockstream" /></p>
<p>圖片來源: <a href="https://blockstream.info">blockstream</a></p>
<p>在<a href="https://blockstream.info">這裡</a>你可以看到每個區塊中的交易，上圖便是一筆交易動用了兩個UTXO後，生成四個新的UTXO給不同的對方，會使用到兩個UTXO代表單一UTXO並無法支應全部的開銷。</p>
<p><img src="http://www.lkm543.site/it_iron_man/day26_4.jpg" alt="blockstream" /></p>
<p>圖片來源: <a href="https://blockstream.info">blockstream</a></p>
<p>展開交易紀錄你也可以直接看到哪幾個UTXO是處在尚未被使用(Unspent)的狀態，因此帳戶目前可以動用餘額(Balance)其實就是所有持有UTXO的金額總和！</p>
<p>打開Bitcoin的<a href="https://www.blockchain.com/explorer">區塊鏈瀏覽器</a>你更可以看到目前總共有大約6000萬個<a href="https://utxo-stats.com/">UTXO</a>，至於目前Transaction的總數目大約落在5億左右(<a href="https://www.quandl.com/data/BCHAIN/NTRAT-Bitcoin-Total-Number-of-Transactions">參考資料</a>)。</p>
<h3 id="utxo如何預防雙花攻擊"><a class="header" href="#utxo如何預防雙花攻擊">UTXO如何預防雙花攻擊</a></h3>
<p>UTXO如同支票一般，限制了每張支票(UTXO)都只能夠被使用一次，透過了限制UTXO的使用次數來避免雙花攻擊。但UTXO有個缺陷就是在交易被納入區塊前，該UTXO是可以無限制地被使用的，至於哪筆交易會實際被礦工採納則視交易手續費決定，因此在收款前請務必確認UTXO已被礦工打包進入區塊中。</p>
<h3 id="utxo的優點"><a class="header" href="#utxo的優點">UTXO的優點</a></h3>
<h4 id="scalability"><a class="header" href="#scalability">Scalability</a></h4>
<p>UTXO的架構是以UTXO為單位進行交易，因此可以同時發起複數個交易給不同的收款方，在擴展性上有優勢。</p>
<h4 id="privacy"><a class="header" href="#privacy">Privacy</a></h4>
<p>雖然Bitcoin並沒有辦法做到完全的資訊隱藏，但在UTXO架構下以支票為單位作為交易相較容易保障雙方的隱私。</p>
<h2 id="ethereum的account架構"><a class="header" href="#ethereum的account架構">Ethereum的Account架構</a></h2>
<p>上頭提到UTXO的架構有個缺陷是在UTXO正式進入區塊前該UTXO可被使用無數次，因此匯款方可以使用同一個UTXO重複付款，一但收款方沒有仔細確認是否已經被區塊打包就可能受騙上當，在Ethereum的白皮書<a href="http://blockchainlab.com/pdf/Ethereum_white_paper-a_next_generation_smart_contract_and_decentralized_application_platform-vitalik-buterin.pdf">A Next-Generation Smart Contract and Decentralized Application Platform</a>中是這樣舉例的：</p>
<blockquote>
<p>If one entity has 50 BTC, and simultaneously sends the same 50 BTC to A and to B, only the transaction that gets confirmed first will process.</p>
</blockquote>
<p>因此Ethereum採用的是Account架構，也就是相當於銀行的簽帳卡，每張簽帳卡都有對應到帳戶的餘額，每次發送交易前也都會再次確認餘額是否足夠，Ethereum上同時也會記錄每個錢包地址目前的餘額。</p>
<p><img src="http://www.lkm543.site/it_iron_man/day26_5.JPG" alt="Etherscan" /></p>
<p>圖片來源: <a href="https://etherscan.io/address/0xc88f7666330b4b511358b7742dc2a3234710e7b1">etherscan</a></p>
<p>在<a href="https://etherscan.io/">Etherscan</a>上，任意點開一個地址(上圖)，便可以發現裏頭清楚記錄了關於這個地址每一筆交易的相關細節，像是收款方、匯款方、金額、或手續費等。這便是我們提到的Account架構─每個帳戶都清楚記錄了目前的狀態，交易明細也只要簡單記錄收款與匯款方即可。</p>
<h3 id="account架構如何預防雙花攻擊"><a class="header" href="#account架構如何預防雙花攻擊">Account架構如何預防雙花攻擊</a></h3>
<p>為了避免雙花攻擊，Ethereum會給單一Account發出的交易一個逐漸遞增的nonce值，也就是下圖中的紅色框框，nonce值較小的交易便會優先執行，因此收款方便可以透過查閱該帳戶所有簽發過的交易次序來事先確認該交易的優先順序為何。</p>
<p><img src="http://www.lkm543.site/it_iron_man/day26_6.JPG" alt="Etherscan" /></p>
<p>圖片來源: <a href="https://etherscan.io/tx/0x5b9e49b7d8f1a8709ab8f334691c4152ea395ada213159679ff3292f1dcd3a76">etherscan</a></p>
<h3 id="input-data"><a class="header" href="#input-data">Input Data</a></h3>
<p>如果你有仔細看的話應該會發現Ethereum的交易紀錄中有一欄<code>Input Data</code>，該欄位也可以拿來觸發過幾天後我們會提到的智能合約的功能，透過Input Data告知區塊鏈上的礦工我們想要觸發智能合約裡的哪個函式，或是可以用來記錄這筆交易的用途，有時候甚至會利用區塊鏈的不可竄改特性特意遺留某些文字在區塊鏈上。</p>
<p>比方說在<a href="https://etherscan.io/tx/0xf56d81301da93f71368ad7f8d605648d77be6edb13e8875cf3e5906f38d1b548">這裡</a>你可以看到由Ryu Gi-hyeok寫入的南北韓和平宣言(下圖)，或是由不知名人士為避免政府封鎖所寫入的<a href="https://etherscan.io/tx/0x2d6a7b0f6adeff38423d4c62cd8b6ccb708ddad85da5d3d06756ad4d8a04a6a2">北大性侵案</a>。要觀看這些文字只需要簡單按下Click to see More，並再View input as那欄選擇UTF-8便可以用文字的形式閱讀。</p>
<p><img src="http://www.lkm543.site/it_iron_man/day26_7.JPG" alt="Etherscan" /></p>
<p>圖片來源: <a href="https://etherscan.io/tx/0xf56d81301da93f71368ad7f8d605648d77be6edb13e8875cf3e5906f38d1b548">etherscan</a></p>
<h3 id="account架構的優點"><a class="header" href="#account架構的優點">Account架構的優點</a></h3>
<h4 id="simplicity"><a class="header" href="#simplicity">Simplicity</a></h4>
<p>Account架構的優點就是簡單明瞭，跟我們平常生活中所使用的銀行、金融卡原理上是一致的，相較容易被大眾理解與接受。</p>
<h4 id="efficiency"><a class="header" href="#efficiency">Efficiency</a></h4>
<p>Account架構的另一個優點是在簡單、一對一的交易中效率較高，只需要單純對兩方的餘額做增減，並不需要產生額外的UTXO即可完成。</p>
<p>到目前為止的文章都會放置在<a href="https://github.com/lkm543/it_iron_man_2019">Github</a>上。</p>
<h1 id="ref"><a class="header" href="#ref">Ref:</a></h1>
<ul>
<li><a href="https://medium.com/@sunflora98/utxo-vs-account-balance-model-5e6470f4e0cf">UTXO vs Account/Balance Model</a></li>
<li><a href="https://steemit.com/cn-cryptocurrency/@antonsteemit/utxo">比特幣UTXO模型介紹-如何解讀比特幣交易</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/57272282">UTXO 和 Account 模型对比</a></li>
<li><a href="https://www.blocktempo.com/historic-korean-peace-declaration-recorded-on-ethereum-blockchain/">【以太坊區塊鏈】紀錄歷史性的一刻：南北韓和平宣言</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="day24.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="day26.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="day24.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="day26.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
