<!DOCTYPE HTML>
<html lang="zh-TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Day04|打造一個簡易的區塊鏈(3)：難度調整與確認哈希鏈 - 區塊鏈到底在幹嘛 - 30天系列</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">區塊鏈到底在幹嘛 - 30天系列</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="day04打造一個簡易的區塊鏈3難度調整與確認哈希鏈"><a class="header" href="#day04打造一個簡易的區塊鏈3難度調整與確認哈希鏈">Day04|打造一個簡易的區塊鏈(3)：難度調整與確認哈希鏈</a></h1>
<p>昨天我們已經有能力產生出新區塊，但區塊的產生時間會根據運算力的多寡而浮動，因此今天我們要處理的第一件事便是根據現在運算力多寡調整挖礦的難度，除此之外我們在處理交易前也必須事先確認該帳戶的餘額是否足夠，最後是確認我們的區塊鏈是不是有被竄改過。</p>
<p>總結今天的三件事情：</p>
<ol>
<li>調整哈希難度</li>
<li>計算帳戶餘額</li>
<li>確認哈希值是否正確</li>
</ol>
<h1 id="調整哈希難度"><a class="header" href="#調整哈希難度">調整哈希難度</a></h1>
<p>由於每區塊裏頭都記錄著區塊被挖掘出的當下時間戳(<code>timestamp</code>)，因此我們可以知道每個區塊的產出時間(也就是找出符合的<code>nonce</code>所耗費的時間)，如果難度是固定的，那麼參與挖礦的運算力如果成長十倍，區塊的平均產出時間也會連帶變成十分之一，因此順應運算力的多寡而調整難度對區塊鏈的長久運行是很重要的。</p>
<p>那怎麼去評估區塊的產生時間呢？如果單純採用前一個區塊的產出時間很明顯的是不可行，因為<code>POW</code>的核心精神是利用隨機數去猜到可能可以符合的<code>nonce</code>，因此每一個區塊的產出時間會變動相當大：</p>
<p><img src="https://www.lkm543.site/it_iron_man/day4_1.jpg" alt="Block time diversity" /></p>
<p>根據上圖看到我們的區塊鏈在難度5的狀況下，連續十塊的出塊時間從0.47秒到39.44秒都有可能，昨天提到的<a href="https://www.blockchain.com/explorer">區塊鍊瀏覽器</a>裏頭也可以發現出塊時間會不斷跳動，因此根據單個區塊的出塊時間決定難度是萬萬不可行的，取而代之的方法便是取多個區塊的出塊時間再取平均，有點像是訊號處理中的均值濾波器。</p>
<p>在這裡我們設定如果平均出塊時間小於設定的出塊時間，就把難度加1，如果平均出塊時間大於設定的出塊時間，就把難度減1。這裡難度的定義是挖到的<code>nonce</code>值必須要滿足讓Hash的頭幾個Bytes為0，因此難度每加1，實際上的運算量會增加16倍(位元組是兩兩16進位構成的)，也因為調整幅度太大，所以其實這裡設計的並不是很好的難度調整算法。</p>
<pre><code>def adjust_difficulty(self):
    if len(self.chain) % self.adjust_difficulty_blocks != 1:
        return self.difficulty
    elif len(self.chain) &lt;= self.adjust_difficulty_blocks:
        return self.difficulty
    else:
        start = self.chain[-1*self.adjust_difficulty_blocks-1].timestamp
        finish = self.chain[-1].timestamp
        average_time_consumed = round((finish - start) / (self.adjust_difficulty_blocks), 2)
        if average_time_consumed &gt; self.block_time:
            print(f"Average block time:{average_time_consumed}s. Lower the difficulty")
            self.difficulty -= 1
        else:
            print(f"Average block time:{average_time_consumed}s. High up the difficulty")
            self.difficulty += 1
</code></pre>
<p>實際上比特幣每過2016個區塊，會根據前面2016個區塊的平均出塊時間調整難度，如果前面2016個區塊的平均出塊時間大於十分鐘，代表現在的運算力過少、挖礦難度偏高使出塊時間變長，因此需要降低挖礦難度；反之如果這2016個區塊的平均出塊時間小於十分鐘，代表現在的運算力過多、挖礦難度偏低使出塊時間變短，因此需要提升挖礦難度。這2016個區塊所需的時間大概是：</p>
<p><img src="https://chart.googleapis.com/chart?cht=tx&amp;chl=2016(Blocks)*10(Minutes%20per%20Block)%2F1440(Minutes%20per%20Day)%3D14(Days)" alt="https://chart.googleapis.com/chart?cht=tx&amp;chl=2016(Blocks)*10(Minutes%20per%20Block)%2F1440(Minutes%20per%20Day)%3D14(Days))" />)</p>
<p>也就是平均大約兩個禮拜Bitcoin會調整一次難度。你也可以在<a href="https://bitinfocharts.com/comparison/bitcoin-difficulty.html">這個網站</a>上看到歷史Bitcoin/Ethereum的挖礦難度。如果真的點開那個網站，應該可以很快發現難度往往是不斷增加而很少下降的，造成難度不斷上漲的主要原因有兩點：</p>
<ol>
<li>幣價上漲導致更多人參與挖礦以獲取Bitcoin</li>
<li>硬體效能的進步使運算能力飛速成長</li>
</ol>
<p>特別是第二點的硬體能力，BTC使用的<code>SHA-256</code>挖礦演算法目前已經被特殊應用積體電路（Application-specific integrated circuit，ASIC）所主宰，個人PC的硬體效能已經無力跟ASIC競爭。非但如此，ASIC的推陳出新也逐步刷新效能的上限，<a href="https://en.bitcoin.it/wiki/Mining_hardware_comparison">這裡</a>可以看到各ASIC主要型號的運算力，從運算力中可以發現比特大陸的Antminer S1出到S9的過程中，運算力整整增加了快80倍(180,000Mh/s→14,000,000Mh/s)，如果難度保持不便，即使在機台數都沒有增加的狀況下，出塊的時間也會縮短成1/80，多麼可怕的數據。</p>
<p>關於挖礦相關的技術細節，我們在之後的挖礦實戰會細談這件事情。</p>
<h1 id="計算帳戶餘額"><a class="header" href="#計算帳戶餘額">計算帳戶餘額</a></h1>
<p>除了難度調整，在發起交易當下也必須檢查匯款人的餘額是否足夠，同時也限制不能匯出超過自己帳戶的餘額，而帳戶餘額總共只有三種來源：</p>
<ul>
<li>區塊獎勵：挖出區塊的礦工能得到區塊的獎勵</li>
<li>手續費收入：挖出區塊的礦工能得到該比區塊內所有交易的手續費</li>
<li>匯款收入：收到別人匯款的款項</li>
</ul>
<p>因此我們寫一個簡單的函式，從第一個區塊的第一筆交易開始檢查，一路檢查到最後一筆後便可以得到該帳戶的餘額。</p>
<pre><code>def get_balance(self, account):
    balance = 0
    for block in self.chain:
        # Check miner reward
        miner = False
        if block.miner == account:
            miner = True
            balance += block.miner_rewards
        for transaction in block.transactions:
            if miner:
                balance += transaction.fee
            if transaction.sender == account:
                balance -= transaction.amounts
                balance -= transaction.fee
            elif transaction.receiver == account:
                balance += transaction.amounts
    return balance
</code></pre>
<h1 id="確認哈希值是否正確"><a class="header" href="#確認哈希值是否正確">確認哈希值是否正確</a></h1>
<p>為了避免我們的資料被竄改，也必須時常檢查資料的正確性。還記得我們每個區塊的哈希數都是環環相扣的吧?在昨天每個哈希數都由下面這四筆資料計算出來：</p>
<ol>
<li>前一個區塊的hash(<code>previous_hash</code>)</li>
<li>區塊產生的時間戳</li>
<li>所有的交易紀錄</li>
<li><code>nonce</code></li>
</ol>
<p>所以檢查的方式就是從第一個區塊的哈希數一路算到最後一個，一旦中間開始的某個哈希數算完之後對不起來，那麼就代表其中的某筆交易紀錄被竄改過。</p>
<pre><code>def verify_blockchain(self):
    previous_hash = ''
    for idx,block in enumerate(self.chain):
        if self.get_hash(block, block.nonce) != block.hash:
            print("Error:Hash not matched!")
            return False
        elif previous_hash != block.previous_hash and idx:
            print("Error:Hash not matched to previous_hash")
            return False
        previous_hash = block.hash
    print("Hash correct!")
    return True
</code></pre>
<h2 id="測試一下"><a class="header" href="#測試一下">測試一下：</a></h2>
<p>如果我們在其中一個區塊插入了一筆偽造的交易，那麼透過一連串哈希的確認與計算，我們便可以發現hash數是對不起來的！</p>
<pre><code>if __name__ == '__main__':
    block = BlockChain()
    block.create_genesis_block()
    block.mine_block('lkm543')

    block.verify_blockchain()
    
    print("Insert fake transaction.")
    fake_transaction = Transaction('test123', address, 100, 1, 'Test')    
    block.chain[1].transactions.append(fake_transaction)
    block.mine_block('lkm543')

    block.verify_blockchain()
</code></pre>
<p><img src="https://www.lkm543.site/it_iron_man/day4_2.jpg" alt="Fake Transaction" /></p>
<p>除此之外你也可以到<a href="https://anders.com/blockchain/blockchain">這裡</a>玩玩看區塊鏈，一開始所有資料都是正確無誤的，所以會顯示綠色：</p>
<p><img src="https://www.lkm543.site/it_iron_man/day4_3.jpg" alt="Demo" /></p>
<p>一旦你在前面區塊中亂插入一些紀錄，你會發現從該區塊之後的所有哈希數通通被打亂了！像是在這裡我插入：<br />
<code>"I am Bill Gates"</code></p>
<p><img src="https://www.lkm543.site/it_iron_man/day4_4.jpg" alt="Demo" /></p>
<p>被更改的區塊後的所有區塊都必須從新被計算哈希數，否則會完全對不起來而被輕易發現資料被竄改過！當然可以選擇重新計算所有的哈希數，但當主鏈夠長時，重新計算所有的哈希數所需要的運算量與成本非常可怕，也因此保障了區塊鏈的不可竄改性。更何況在重新計算時，正常的塊也在不停的被一般的礦工產出，要跟所有的礦工競爭幾近天方夜譚。</p>
<h1 id="今天的問題"><a class="header" href="#今天的問題">今天的問題</a></h1>
<p>但有個問題：我要怎麼知道發起交易的那方便是帳戶的持有者？如果不事先確認的話，代表任意路人都可以把別人的帳戶餘額領走，是萬萬不可的事情。那麼我們又要如何確認誰擁有這個帳號？誰有權力發起交易？</p>
<p>到目前為止的文章都會放置在<a href="https://github.com/lkm543/it_iron_man_2019">Github</a>上，至於程式碼則放在<a href="https://github.com/lkm543/it_iron_man_2019/blob/master/code/day04.py">這裡</a>。</p>
<h1 id="ref"><a class="header" href="#ref">Ref:</a></h1>
<ul>
<li><a href="https://kknews.cc/zh-tw/tech/mpz4rjg.html">比特幣系統是如何調整挖礦難度的？</a></li>
<li><a href="https://medium.com/fpga-guide/cryptocurrency-mining-why-use-fpga-for-mining-fpga-vs-gpu-vs-asic-explained-5aaa400082b9">Cryptocurrency Mining: Why Use FPGA for Mining? FPGA vs GPU vs ASIC Explained</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="day03.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="day05.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="day03.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="day05.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
